<!DOCTYPE html>
<html>
<head>
    <title>Construction Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        window.mermaid = mermaid;
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            flowchart: {
                curve: 'basis',
                padding: 20
            }
        });
    </script>
    <style>
        body {
            background: url('https://asbl.in/wp-content/uploads/2022/09/ASBL-Spectra-1.jpg') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Montserrat', Arial, sans-serif;
        }
        .dashboard-bg {
            background: rgba(20, 20, 30, 0.90);
            border-radius: 18px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.25);
            padding: 32px 24px 24px 24px;
            margin: 32px auto;
            max-width: 1400px;
        }
        h2, h4, h5 { color: #fff; letter-spacing: 1px; }
        .summary-table th, .summary-table td { font-size: 1.1rem; }
        .status-completed { color: #00e676; font-weight: bold; }
        .status-pending { color: #ff5252; font-weight: bold; }
        .status-inprogress { color: #ffd600; font-weight: bold; }
        .card-table {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.10);
            margin-bottom: 18px;
            padding: 18px;
        }
        .table thead th {
            background: #0d6efd;
            color: #fff;
            font-size: 1.1rem;
        }
        .highlight { background: #d1ffd1 !important; }
        .form-label, label, .fs-5 { color: #fff; }
        .btn-primary, .btn-success { font-size: 1.1rem; font-weight: 600; }
        .table td, .table th { vertical-align: middle; }
        @media (max-width: 1200px) {
            .dashboard-bg { padding: 16px 4px; }
        }
        @media (max-width: 900px) {
            .dashboard-bg { padding: 4px 0; }
            .card-table { padding: 8px; }
        }
        #sidebar {
            min-width: 250px;
            height: 100vh;
            background: linear-gradient(135deg, #0d47a1 0%, #42a5f5 100%);
            box-shadow: 2px 0 12px rgba(0,0,0,0.15);
        }
        #sidebar h3 {
            font-family: 'Montserrat', Arial, sans-serif;
        }
        #sidebar .nav-link.active, #sidebar .nav-link:hover {
            background: #1976d2 !important;
            color: #fff !important;
        }
        .sidebar-section { display: none; }
        .sidebar-section.active { display: block; }
        #cpm-mermaid {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            overflow-x: auto;
        }
        .mermaid {
            font-family: 'Montserrat', Arial, sans-serif;
        }
        .score-details {
            font-size: 0.9rem;
            color: #666;
        }
        .score-breakdown {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .parallel-group {
            margin-top: 10px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
        }
        .modal-content {
            border-radius: 12px;
        }
        .modal-header {
            background: #0d6efd;
            color: white;
            border-radius: 12px 12px 0 0;
        }
        .modal-title {
            font-weight: 600;
        }
        .score-component {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .score-weight {
            font-size: 0.8rem;
            color: #666;
        }
        .score-value {
            font-weight: 600;
            color: #0d6efd;
        }
        .sequence-option {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .sequence-option.best {
            border: 2px solid #198754;
            background-color: #f8fff9;
        }
        .recommendation {
            background: #e3f2fd;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .constraint-warning {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .sequence-table {
            width: 100%;
            margin-top: 10px;
        }
        .sequence-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .sequence-table td, .sequence-table th {
            padding: 8px;
            border: 1px solid #dee2e6;
        }
        .sequence-badge {
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 5px;
        }
        .sequence-badge.first {
            background: #198754;
            color: white;
        }
        .sequence-badge.later {
            background: #0dcaf0;
            color: white;
        }
        .score-detail-row {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .score-detail-label {
            font-weight: 600;
            color: #0d6efd;
        }
        .score-detail-value {
            color: #198754;
        }
        .parallel-activities {
            margin-top: 15px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
        }
        .parallel-activity-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #0d6efd;
        }
        .sequence-analysis {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .sequence-analysis h6 {
            color: #0d6efd;
            margin-bottom: 10px;
        }
        .sequence-analysis-table {
            width: 100%;
            margin-top: 10px;
        }
        .sequence-analysis-table th {
            background: #e3f2fd;
            font-weight: 600;
        }
        .sequence-analysis-table td, .sequence-analysis-table th {
            padding: 8px;
            border: 1px solid #dee2e6;
        }
        .sequence-analysis-table tr:hover {
            background-color: #f8f9fa;
        }
        .sequence-analysis-table .best-sequence {
            background-color: #e8f5e9;
        }
        .sequence-analysis-table .best-sequence td {
            font-weight: 600;
        }
        .sequence-analysis-table .delay-cost {
            color: #dc3545;
            font-weight: 600;
        }
        .sequence-analysis-table .score {
            color: #198754;
            font-weight: 600;
        }
        .sequence-analysis-table .position {
            width: 80px;
            text-align: center;
        }
        .sequence-analysis-table .activity {
            min-width: 200px;
        }
        .sequence-analysis-table .cost {
            width: 120px;
            text-align: right;
        }
        .sequence-analysis-table .score {
            width: 100px;
            text-align: right;
        }
        .sequence-analysis-table .status {
            width: 100px;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="d-flex">
    <nav id="sidebar" class="bg-gradient-primary flex-shrink-0 p-3">
        <h3 class="text-white mb-4">üèóÔ∏è Project Menu</h3>
        <ul class="nav nav-pills flex-column mb-auto" id="sidebar-nav">
            <li class="nav-item mb-2">
                <a href="#" class="nav-link text-white active" data-section="dashboard" style="font-size: 1.1rem; background: rgba(255,255,255,0.08); border-radius: 8px;">
                    Project Overview
                </a>
            </li>
            <li class="nav-item mb-2">
                <a href="#" class="nav-link text-white" data-section="cpm" style="font-size: 1.1rem; background: rgba(255,255,255,0.08); border-radius: 8px;">
                    CPM Schedule
                </a>
            </li>
            <li class="nav-item mb-2">
                <a href="#" class="nav-link text-white" data-section="cost-analysis" style="font-size: 1.1rem; background: rgba(255,255,255,0.08); border-radius: 8px;">
                    Cost Analysis
                </a>
            </li>
            <li class="nav-item mb-2">
                <a href="#" class="nav-link text-white" data-section="settings" style="font-size: 1.1rem; background: rgba(255,255,255,0.08); border-radius: 8px;">
                    Settings
                </a>
            </li>
        </ul>
        <hr class="text-white">
        <div class="text-white-50">Powered by Construction AI</div>
    </nav>
    <div class="dashboard-bg flex-grow-1">
        <!-- DASHBOARD SECTION -->
        <div id="dashboard-section" class="sidebar-section active">
            <h2 class="mb-4 text-center">üèôÔ∏è Construction Project Prioritization Dashboard</h2>
            <form method="post">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="current_day" class="form-label"><b>Project Day:</b></label>
                        <input type="number" class="form-control" name="current_day" id="current_day" value="{{ current_day }}" min="1" max="{{ total_duration }}" required>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Go to Day</button>
                    </div>
                    <div class="col-md-4 d-flex align-items-end justify-content-end">
                        <span class="fs-5"><b>Total Project Duration:</b> {{ critical_paths[0]|sum(attribute='duration') if critical_paths else 0 }} days</span>
                    </div>
                </div>
                <input type="hidden" name="prev_ready" value="{{ prev_ready }}">

                <div class="row">
                    <div class="col-lg-6">
                        <div class="card-table">
                            <h4>All Activities Overview</h4>
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped align-middle summary-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Activity</th>
                                            <th>Duration</th>
                                            <th>Planned Manpower</th>
                                            <th>Dependencies</th>
                                            <th>Status</th>
                                            <th>Actual Completion Day</th>
                                            <th>Planned Finish Day</th>
                                            <th>Delay Days</th>
                                            <th>Planned Cost (‚Çπ)</th>
                                            <th>Actual Cost (‚Çπ)</th>
                                            <th>Delay Cost (‚Çπ)</th>
                                            <th style="background:#42a5f5;color:#fff;">Delay Cost/Day (‚Çπ)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for activity in summary %}
                                        <tr>
                                            <td>{{ activity.id }}</td>
                                            <td>{{ activity.name }}</td>
                                            <td>{{ activity.duration }}</td>
                                            <td>{{ activity.planned_manpower }}</td>
                                            <td>{% if activity.dependency_ids %}{{ activity.dependency_ids|join(', ') }}{% else %}-{% endif %}</td>
                                            <td>
                                                {% if activity.status == "Completed" %}
                                                    <span class="status-completed">Completed</span>
                                                {% elif activity.status == "Completed Today" %}
                                                    <span class="status-inprogress">Completed Today</span>
                                                {% else %}
                                                    <span class="status-pending">Pending</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ activity.actual_completion_day }}</td>
                                            <td>{{ activity.planned_finish_day }}</td>
                                            <td>{{ activity.delay_days }}</td>
                                            <td>‚Çπ{{ activity.planned_cost }}</td>
                                            <td>
                                                {% if activity.actual_cost > activity.planned_cost %}
                                                    <span class="text-danger fw-bold">‚Çπ{{ activity.actual_cost }}</span>
                                                {% else %}
                                                    ‚Çπ{{ activity.actual_cost }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if activity.delay_cost > 0 %}
                                                    <span class="text-danger fw-bold">‚Çπ{{ activity.delay_cost }}</span>
                                                {% else %}
                                                    ‚Çπ0
                                                {% endif %}
                                            </td>
                                            <td style="background:#e3f2fd;">‚Çπ{{ activity.total_delay_cost_per_day if activity.total_delay_cost_per_day else '-' }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card-table">
                            <h4>Mark Completed Activities</h4>
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped align-middle">
                                    <thead>
                                        <tr>
                                            <th>Complete?</th>
                                            <th>Activity</th>
                                            <th>Dependencies</th>
                                            <th>Actual Completion Day</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for activity in all_activities %}
                                        <tr>
                                            <td>
                                                <input type="checkbox" name="complete_{{ activity.id }}"
                                                    {% if actual_completion_days.get(activity.id, 0) and current_day > actual_completion_days[activity.id] %}checked{% endif %}>
                                            </td>
                                            <td>{{ activity.name }}</td>
                                            <td>{% if activity.dependency_ids %}{{ activity.dependency_ids|join(', ') }}{% else %}-{% endif %}</td>
                                            <td>
                                                {% if actual_completion_days.get(activity.id) %}
                                                    {{ actual_completion_days[activity.id] }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card-table">
                            <h4>Available Activities for Day {{ current_day }}</h4>
                            {% if parallel_groups %}
                            <div class="recommendation">
                                <h5>üìä Parallel Activity Analysis</h5>
                                <p>We've analyzed all possible sequences for parallel activities. The recommended sequence is shown below, optimized for minimum total delay cost.</p>
                            </div>
                            {% endif %}
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped align-middle">
                                    <thead>
                                        <tr>
                                            <th>Activity</th>
                                            <th>Planned Manpower</th>
                                            <th>Available Manpower</th>
                                            <th>Man in other site</th>
                                            <th>Material Availability</th>
                                            <th>Equipment Avail.</th>
                                            <th>Planned Cost (‚Çπ)</th>
                                            <th style="background:#42a5f5;color:#fff;">Delay Cost/Day (‚Çπ)</th>
                                            <th>Sequence Position</th>
                                            <th>Total Score</th>
                                            <th>Score Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for activity in activities %}
                                        <tr>
                                            <td>{{ activity.name }}</td>
                                            <td>{{ activity.planned_manpower }}</td>
                                            <td>
                                                <input type="number" class="form-control" name="available_manpower_{{ activity.id }}" 
                                                    value="{{ activity.available_manpower }}" readonly>
                                                {% if activity.available_manpower < activity.planned_manpower %}
                                                <div class="constraint-warning">
                                                    ‚ö†Ô∏è Manpower shortage: {{ activity.planned_manpower - activity.available_manpower }} workers needed
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <input type="number" class="form-control manpower-other-site" 
                                                    name="manpower_idle_{{ activity.id }}" 
                                                    value="{{ activity.manpower_in_other_site|default(0) }}" 
                                                    min="0" max="{{ activity.planned_manpower }}" 
                                                    data-planned-manpower="{{ activity.planned_manpower }}"
                                                    data-activity-id="{{ activity.id }}"
                                                    required>
                                                {% if activity.manpower_in_other_site > 0 %}
                                                <div class="text-warning">
                                                    ‚ö†Ô∏è {{ activity.manpower_in_other_site }} workers at other sites
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <select class="form-select material-availability" 
                                                    name="material_type_{{ activity.id }}" 
                                                    data-activity-id="{{ activity.id }}"
                                                    required>
                                                    <option value="100" {% if activity.material == 1.0 %}selected{% endif %}>100% Available</option>
                                                    <option value="custom" {% if activity.material != 1.0 and activity.material != 0 %}selected{% endif %}>Custom Percentage</option>
                                                    <option value="0" {% if activity.material == 0 %}selected{% endif %}>Not Available</option>
                                                </select>
                                                <div class="material-percentage mt-2" style="display: {% if activity.material != 1.0 and activity.material != 0 %}block{% else %}none{% endif %};">
                                                    <input type="number" class="form-control" 
                                                        name="material_percentage_{{ activity.id }}" 
                                                        value="{{ (activity.material * 100)|round }}" 
                                                        min="0" max="100" step="1"
                                                        placeholder="Enter percentage">
                                                </div>
                                            </td>
                                            <td>
                                                <select class="form-select" name="equipment_type_{{ activity.id }}">
                                                    <option value="owned" {% if activity.equipment_type == 'owned' %}selected{% endif %}>Owned (‚Çπ{{ activity.owned_equipment_om_cost_per_day }}/day)</option>
                                                    <option value="rented" {% if activity.equipment_type == 'rented' %}selected{% endif %}>Rented (‚Çπ{{ activity.rented_equipment_cost_per_day }}/day)</option>
                                                    <option value="no_equipment" {% if activity.equipment_type == 'no_equipment' %}selected{% endif %}>No Equipment (‚Çπ0/day)</option>
                                                </select>
                                            </td>
                                            <td>‚Çπ{{ activity.planned_cost }}</td>
                                            <td style="background:#e3f2fd;">‚Çπ{{ activity.delay_cost_per_day if activity.delay_cost_per_day else '-' }}</td>
                                            <td>
                                                {% if activity.is_first_in_parallel %}
                                                    <span class="badge bg-success">First in Sequence</span>
                                                {% else %}
                                                    <span class="badge bg-info">Later in Sequence</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="fw-bold {% if activity.is_first_in_parallel %}text-success{% endif %}">
                                                    {{ activity.total_score }}
                                                </span>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#scoreModal{{ activity.id }}">
                                                    View Details
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-grid gap-2 mt-3">
                                <button type="submit" class="btn btn-success btn-lg">Update & Prioritize</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Score Detail Modals -->
            {% for activity in activities %}
            <div class="modal fade" id="scoreModal{{ activity.id }}" tabindex="-1" aria-labelledby="scoreModalLabel{{ activity.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="scoreModalLabel{{ activity.id }}">Score Details for {{ activity.name }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="score-breakdown">
                                <h6>Score Components:</h6>
                                <div class="row score-details mb-3">
                                    <div class="col-md-4">
                                        <span class="score-detail-label">Delay Score:</span>
                                        <span class="score-detail-value">{{ activity.delay_score }}</span>
                                        <div class="score-weight">(Weight: {{ activity.weights.delay }}%)</div>
                                    </div>
                                    <div class="col-md-4">
                                        <span class="score-detail-label">Equipment Score:</span>
                                        <span class="score-detail-value">{{ activity.equipment_score }}</span>
                                        <div class="score-weight">(Weight: {{ activity.weights.equipment }}%)</div>
                                    </div>
                                    <div class="col-md-4">
                                        <span class="score-detail-label">Manpower Score:</span>
                                        <span class="score-detail-value">{{ activity.manpower_score }}</span>
                                        <div class="score-weight">(Weight: {{ activity.weights.manpower }}%)</div>
                                    </div>
                                </div>
                                <div class="row score-details mb-3">
                                    <div class="col-md-6">
                                        <span class="score-detail-label">Material Score:</span>
                                        <span class="score-detail-value">{{ activity.material_score }}</span>
                                        <div class="score-weight">(Weight: {{ activity.weights.material }}%)</div>
                                    </div>
                                    <div class="col-md-6">
                                        <span class="score-detail-label">Critical Path Score:</span>
                                        <span class="score-detail-value {% if activity.is_critical %}text-danger fw-bold{% endif %}">
                                            {{ activity.critical_path_score }}
                                            {% if activity.is_critical %}
                                            <span class="badge bg-danger ms-2">Critical Path</span>
                                            {% elif activity.is_close_to_critical %}
                                            <span class="badge bg-warning ms-2">Near Critical Path</span>
                                            {% endif %}
                                        </span>
                                        <div class="score-weight">(Weight: {{ activity.weights.critical_path }}%)</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Delay Cost Calculation Section -->
                            <div class="delay-cost-breakdown mt-4">
                                <h6>Delay Cost Calculation:</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="mb-3">Base Daily Costs:</h6>
                                                <ul class="list-unstyled">
                                                    <li class="mb-2">
                                                        <strong>Equipment Cost:</strong>
                                                        {% if activity.equipment_type == 'rented' %}
                                                            ‚Çπ{{ activity.rented_equipment_cost_per_day }}/day (Rented)
                                                        {% elif activity.equipment_type == 'owned' %}
                                                            ‚Çπ{{ activity.owned_equipment_om_cost_per_day }}/day (Owned)
                                                        {% else %}
                                                            ‚Çπ0/day (No Equipment)
                                                        {% endif %}
                                                    </li>
                                                    <li class="mb-2">
                                                        <strong>Manpower Cost:</strong>
                                                        ‚Çπ{{ activity.manpower_cost_per_day }}/day
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="mb-3">Site Overhead Impact:</h6>
                                                <ul class="list-unstyled">
                                                    {% if activity.is_critical %}
                                                    <li class="mb-2">
                                                        <strong>Critical Path Status:</strong>
                                                        <span class="text-danger">Full Site Overhead Always Applied</span>
                                                    </li>
                                                    <li class="mb-2">
                                                        <strong>Site Overhead Cost:</strong>
                                                        ‚Çπ{{ activity.site_overhead_cost_per_day }}/day
                                                    </li>
                                                    {% elif activity.is_close_to_critical and activity.is_delayed %}
                                                    <li class="mb-2">
                                                        <strong>Near Critical Path Status:</strong>
                                                        <span class="text-warning">Half Site Overhead Applied (Delayed)</span>
                                                    </li>
                                                    <li class="mb-2">
                                                        <strong>Site Overhead Cost:</strong>
                                                        ‚Çπ{{ (activity.site_overhead_cost_per_day * 0.5)|round }}/day
                                                    </li>
                                                    {% elif activity.is_close_to_critical %}
                                                    <li class="mb-2">
                                                        <strong>Status:</strong>
                                                        <span class="text-success">No Site Overhead (Not Delayed)</span>
                                                    </li>
                                                    {% else %}
                                                    <li class="mb-2">
                                                        <strong>Status:</strong>
                                                        <span class="text-success">No Site Overhead (Not Critical)</span>
                                                    </li>
                                                    {% endif %}
                                                    <li class="mb-2">
                                                        <strong>Total Delay Cost/Day:</strong>
                                                        ‚Çπ{{ activity.total_delay_cost_per_day }}/day
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <h6>Calculation Formula:</h6>
                                            <div class="bg-light p-3 rounded">
                                                <p class="mb-2">Base Delay Cost = Manpower Cost + Equipment Cost</p>
                                                {% if activity.is_critical %}
                                                <p class="mb-0">Total Delay Cost = Base Delay Cost + Full Site Overhead (Always for Critical Path)</p>
                                                {% elif activity.is_close_to_critical and activity.is_delayed %}
                                                <p class="mb-0">Total Delay Cost = Base Delay Cost + (Site Overhead √ó 0.5) (Only when Delayed)</p>
                                                {% else %}
                                                <p class="mb-0">Total Delay Cost = Base Delay Cost (No Site Overhead)</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% if activity.parallel_group %}
                            <div class="sequence-analysis">
                                <h6>Parallel Activity Analysis:</h6>
                                <p class="text-muted">All possible sequences for parallel activities, optimized for minimum total delay cost.</p>
                                
                                {% for sequence in activity.sequence_options %}
                                <div class="sequence-option {% if sequence.is_best %}best{% endif %}">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">Sequence Option {{ loop.index }}</h6>
                                        {% if sequence.is_best %}
                                        <span class="badge bg-success">Best Option</span>
                                        {% endif %}
                                    </div>
                                    <table class="sequence-analysis-table">
                                        <thead>
                                            <tr>
                                                <th class="position">Position</th>
                                                <th class="activity">Activity</th>
                                                <th class="cost">Delay Cost/Day</th>
                                                <th class="score">Total Score</th>
                                                <th class="status">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for act in sequence.activities %}
                                            <tr {% if sequence.is_best %}class="best-sequence"{% endif %}>
                                                <td class="text-center">{{ loop.index }}</td>
                                                <td>{{ act.name }}</td>
                                                <td class="delay-cost">‚Çπ{{ act.delay_cost }}</td>
                                                <td class="score">{{ act.score.total_score }}</td>
                                                <td class="text-center">
                                                    {% if loop.index == 1 %}
                                                    <span class="sequence-badge first">First</span>
                                                    {% else %}
                                                    <span class="sequence-badge later">Later</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <div class="mt-2">
                                        <strong>Total Delay Cost:</strong> 
                                        <span class="delay-cost">‚Çπ{{ sequence.total_delay_cost }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if activity.constraints %}
                            <div class="mt-4">
                                <h6>Constraints & Recommendations:</h6>
                                <ul class="list-group">
                                    {% for constraint in activity.constraints %}
                                    <li class="list-group-item {% if constraint.is_critical %}list-group-item-danger{% endif %}">
                                        {{ constraint.message }}
                                        {% if constraint.recommendation %}
                                        <div class="text-muted mt-1">{{ constraint.recommendation }}</div>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% if updated %}
            <div class="card-table">
                <h4>Prioritized Activities (Highest Priority First)</h4>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped align-middle">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Activity</th>
                                <th style="background: #42a5f5; color: white;">Total Score</th>
                                <th>Score Details</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for activity in activities %}
                            <tr {% if loop.index0 == 0 %}class="highlight"{% endif %}>
                                <td>{{ loop.index }}</td>
                                <td>{{ activity.name }}</td>
                                <td style="background: #e3f2fd; font-weight: bold; font-size: 1.1rem;">{{ activity.total_score }}</td>
                                <td>
                                    <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#scoreModal{{ activity.id }}">
                                        View Details
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p class="fs-5"><b>Top Priority Activity:</b> {{ activities[0].name if activities else 'None' }}</p>
            </div>
            {% endif %}
        </div>

        <!-- CPM SCHEDULE SECTION -->
        <div id="cpm-section" class="sidebar-section">
            <h2 class="mb-4 text-center">üó∫Ô∏è CPM Schedule (Flowchart)</h2>
            <div class="card-table">
                <div id="cpm-mermaid" class="text-center">
                    <pre class="mermaid">{{ cpm_mermaid }}</pre>
                </div>
                <div class="mt-4">
                    <h4 class="text-center mb-3">Critical Paths</h4>
                    {% for path in critical_paths %}
                    <div class="mb-4">
                        <h5 class="text-center mb-3">Critical Path {{ loop.index }}</h5>
                        <div class="d-flex justify-content-center align-items-center flex-wrap">
                            {% for activity in path %}
                                <div class="d-flex align-items-center">
                                    <div class="text-center">
                                        <span class="badge bg-danger p-2 m-1">{{ activity.name }}</span>
                                        <div class="small text-white mt-1">({{ activity.duration }} days)</div>
                                    </div>
                                    {% if not loop.last %}
                                        <div class="mx-3 d-flex align-items-center">
                                            <i class="fas fa-arrow-right" style="color: #000; font-size: 1.5rem; width: 30px; text-align: center;"></i>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="text-center mt-2">
                            <span class="badge bg-info">Path Duration: {{ path|sum(attribute='duration') }} days</span>
                        </div>
                    </div>
                    {% if not loop.last %}
                        <hr class="text-white">
                    {% endif %}
                    {% endfor %}
                    <div class="text-center mt-4">
                        <h5 class="text-white">Total Project Duration: {{ critical_paths[0]|sum(attribute='duration') if critical_paths else 0 }} days</h5>
                        <p class="text-muted mt-2">Note: The critical paths represent the longest sequences of activities that determine the minimum project duration. Any delay in these activities will directly impact the project completion date. Activities on the critical paths have zero float/slack time.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- COST ANALYSIS SECTION -->
        <div id="cost-analysis-section" class="sidebar-section">
            <h2 class="mb-4 text-center">üí∞ Cost Analysis Dashboard</h2>
            <div class="row">
                <div class="col-12">
                    <div class="card-table">
                        <h4>Cost Overview</h4>
                        <div id="cost-overview-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card-table">
                        <h4>Cost Overrun Analysis</h4>
                        <div id="cost-overrun-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card-table">
                        <h4>Cost Overrun Details</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>Activity</th>
                                        <th>Planned Cost (‚Çπ)</th>
                                        <th>Actual Cost (‚Çπ)</th>
                                        <th>Cost Overrun (‚Çπ)</th>
                                        <th>Overrun %</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for activity in summary %}
                                    <tr>
                                        <td>{{ activity.name }}</td>
                                        <td>‚Çπ{{ activity.planned_cost }}</td>
                                        <td>‚Çπ{{ activity.actual_cost }}</td>
                                        <td>
                                            {% if activity.actual_cost > activity.planned_cost %}
                                                <span class="text-danger fw-bold">‚Çπ{{ activity.actual_cost - activity.planned_cost }}</span>
                                            {% else %}
                                                ‚Çπ0
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if activity.actual_cost > activity.planned_cost %}
                                                <span class="text-danger fw-bold">{{ ((activity.actual_cost - activity.planned_cost) / activity.planned_cost * 100)|round(2) }}%</span>
                                            {% else %}
                                                0%
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if activity.status == "Completed" %}
                                                <span class="status-completed">Completed</span>
                                            {% elif activity.status == "Completed Today" %}
                                                <span class="status-inprogress">In Progress</span>
                                            {% else %}
                                                <span class="status-pending">Pending</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS SECTION -->
        <div id="settings-section" class="sidebar-section">
            <h2 class="mb-4 text-center">‚öôÔ∏è Settings</h2>
            <div class="card-table">
                <h4>Project Owner</h4>
                <p style="font-size:1.2rem;font-weight:bold;color:#1976d2;">{{ owner_name }}</p>
                <hr>
                <p>Settings and future options can be configured here.</p>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Sidebar navigation
    document.querySelectorAll('#sidebar-nav .nav-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('#sidebar-nav .nav-link').forEach(function(l) { l.classList.remove('active'); });
            link.classList.add('active');
            var section = link.getAttribute('data-section');
            document.querySelectorAll('.sidebar-section').forEach(function(sec) { sec.classList.remove('active'); });
            if (section === 'dashboard') document.getElementById('dashboard-section').classList.add('active');
            if (section === 'cpm') {
                document.getElementById('cpm-section').classList.add('active');
                if (window.mermaid) {
                    window.mermaid.init(undefined, document.querySelectorAll('.mermaid'));
                }
            }
            if (section === 'cost-analysis') {
                document.getElementById('cost-analysis-section').classList.add('active');
                renderCostCharts();
            }
            if (section === 'settings') document.getElementById('settings-section').classList.add('active');
        });
    });

    // CPM Mermaid rendering
    try {
        if (window.mermaid) {
            window.mermaid.init(undefined, document.querySelectorAll('.mermaid'));
        }
    } catch (error) {
        console.error('Error rendering CPM diagram:', error);
    }

    // Cost Analysis Charts
    function renderCostCharts() {
        // Cost Overview Chart
        const costOverviewData = [
            {
                x: {{ summary|map(attribute='name')|list|tojson }},
                y: {{ summary|map(attribute='planned_cost')|list|tojson }},
                name: 'Planned Cost',
                type: 'bar',
                marker: {color: '#42a5f5'}
            },
            {
                x: {{ summary|map(attribute='name')|list|tojson }},
                y: {{ summary|map(attribute='actual_cost')|list|tojson }},
                name: 'Actual Cost',
                type: 'bar',
                marker: {color: '#00e676'}
            }
        ];

        const costOverviewLayout = {
            title: 'Planned vs Actual Cost by Activity',
            barmode: 'group',
            xaxis: {title: 'Activities'},
            yaxis: {title: 'Cost (‚Çπ)'},
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#333'},
            showlegend: true,
            legend: {x: 1, xanchor: 'right', y: 1}
        };

        Plotly.newPlot('cost-overview-chart', costOverviewData, costOverviewLayout);

        // Cost Overrun Chart
        const costOverrunData = [{
            x: {{ summary|map(attribute='name')|list|tojson }},
            y: {{ summary|map(attribute='delay_cost')|list|tojson }},
            type: 'bar',
            marker: {
                color: {{ summary|map(attribute='delay_cost')|list|tojson }}.map(cost => cost > 0 ? '#ff5252' : '#00e676')
            }
        }];

        const costOverrunLayout = {
            title: 'Cost Overrun by Activity',
            xaxis: {title: 'Activities'},
            yaxis: {title: 'Cost Overrun (‚Çπ)'},
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#333'}
        };

        Plotly.newPlot('cost-overrun-chart', costOverrunData, costOverrunLayout);
    }

    // Initialize cost charts when cost analysis section is active
    document.querySelector('[data-section="cost-analysis"]').addEventListener('click', function() {
        renderCostCharts();
    });

    // Add this to your existing JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        // Handle manpower in other site changes
        document.querySelectorAll('.manpower-other-site').forEach(function(input) {
            input.addEventListener('change', function() {
                const plannedManpower = parseInt(this.dataset.plannedManpower);
                const manpowerInOtherSite = parseInt(this.value) || 0;
                const availableManpower = Math.max(0, plannedManpower - manpowerInOtherSite);
                
                // Update the available manpower field
                const availableManpowerInput = document.querySelector(`input[name="available_manpower_${this.dataset.activityId}"]`);
                if (availableManpowerInput) {
                    availableManpowerInput.value = availableManpower;
                }
            });
        });

        // Handle material availability changes
        document.querySelectorAll('.material-availability').forEach(function(select) {
            select.addEventListener('change', function() {
                const activityId = this.dataset.activityId;
                const percentageDiv = this.nextElementSibling;
                const percentageInput = percentageDiv.querySelector('input');
                
                if (this.value === 'custom') {
                    percentageDiv.style.display = 'block';
                    percentageInput.required = true;
                } else {
                    percentageDiv.style.display = 'none';
                    percentageInput.required = false;
                    percentageInput.value = this.value;
                }
            });
        });
    });
</script>
</body>
</html>